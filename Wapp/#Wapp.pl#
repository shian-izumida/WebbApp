#!/usr/bin/perl
:q
use strict;
use warnings;
use DBI;
use CGI::Fast;
use Time::HiRes;
my $start_time = Time::HiRes::time;

#’¥Æ’¥ó’¥×’¥ì’¡¼’¥È’¥Õ’¥¡’¥¤’¥ë(’¥È’¥Ã’¥×)
my $top = "../../WA/tmpl/top.html";
#my $top = "../../html/WA/tmpl/top.html";

#’¥Æ’¥ó’¥×’¥ì’¡¼’¥È’¥Õ’¥¡’¥¤’¥ë(’¥³’¡¼’¥¹’ºî’À®’ÍÑ)
my $create_course = "../../WA/tmpl/create.html";
#my $create_course = "../../html/WA/tmpl/create.html";

#’¥Æ’¥ó’¥×’¥ì’¡¼’¥È’¥Õ’¥¡’¥¤’¥ë(’¥³’¡¼’¥¹’´°’À®’¸å)
my $created_course = "../../WA/tmpl/created.html";
#my $created_course = "../../html/WA/tmpl/created.html";

#’¥Æ’¥ó’¥×’¥ì’¡¼’¥È’¥Õ’¥¡’¥¤’¥ë(’Á´’¥³’¡¼’¥¹)
my $all_course ="../../WA/tmpl/all.html";
#my $all_course ="../../html/WA/tmpl/all.html";

#---------------------
#’Àß’Äê’´°’Î»
#---------------------
my $mode;
my $post_data;
my $course_id; 
my $course_title;
my $topic;
my $day_length;
my $price;
my $level_id;
my $category;
my $dbh;
my $renew;
my $renew_post;
my $key;

&parse_form;
&header();
if($mode eq "main"){ &main; }
if($mode eq "create"){ &create; }
if($mode eq "all"){ &all_course;}
#if($mode eq "key"){ &key; }
if($key ne ""){ &key; }
if($post_data){ &post_data; }
if($mode eq "" && $key eq "" && $post_data eq "" && $renew_post eq ""){&main;}
if($renew_post){ &renew_post;} #’¹¹’¿·’»þ’¤Ë’¤Ï’¡¢’¥Ç’¡¼’¥¿’ÁÞ’Æþ’¤ò’¹Ô’¤¦
&fooder();


#---------------------
#’¥È’¥Ã’¥×’²è’ÌÌ’É½’¼¨
#---------------------
sub main{

print <<EOM;	
<h3>Training DB Webapp</h3>
<h3>Search</h3>
<a href="Wapp.pl?mode=all">all course</a>
<p>
<form action="Wapp.pl?mode=key" method="post">
	keyword:
	<input type="text" name="key" size="35">
	<input type="submit" value="’Á÷’¿®"><br>
</form>
<form action =serch_cat.pl method="post">
	category:
	<input type="text" name="cat" size="35">
	<input type="submit" value="’Á÷’¿®"><br>
</p>
</form>
EOM
#’¥È’¥Ã’¥×’²è’ÌÌ
#	open IN,"$top";
#	print<IN>;
#	close(IN);
}


#----------------------
#create’¥Õ’¥©’¡¼’¥à’É½’¼¨
#----------------------
sub create{
	#create’¥Õ’¥©’¡¼’¥à’É½’¼¨
	open IN, "$create_course";
	print "<h3> new course</h3>";
	print <IN>;
	close(IN);
}

#----------------------
#’Á´’ÅÐ’Ï¿’¥³’¡¼’¥¹’¤Î’É½’¼¨
#----------------------
sub all_course{

	print "<h3>all course</h3>";

#DB’¤Ë’ÀÜ’Â³
	&dbh();
#’·ï’¿ô’¼è’ÆÀ
my $sql = "select count(*) from course ";
   $sql .= "where category like '%$category%' order by course_id";

my $sth = $dbh->prepare($sql);
if(!$sth->execute){
	print "SQL’¼º’ÇÔ\n";
	exit;
}
my @rec = $sth->fetchrow_array;
my $cnt = $rec[0];
print "rows...$rec[0]\n";

#SQL’¼Â’¹Ô  
$sth = $dbh->prepare(
	"SELECT course_id, course_title, price, level_id, category 
	FROM course
	ORDER BY course_id");
	    
	    if(!$sth->execute){
		    print "SQL’¼º’ÇÔ\n";
		    exit;
	    }
	    #’·ë’²Ì’½Ð’ÎÏ
	    print "<table border=1>\n";
	    print "<tr><th>course_id</th><th>title</th><th>price</th><th>level_id</th><th>category</th></tr>\n";
	    while(my @rec = $sth->fetchrow_array()) {
			    print "<tr>\n";
			    print qq|<td><a href="course_s.pl?mode=$rec[0]"> $rec[0] </a></td>\n|;
			    print "<td>" . $rec[1] . "</td>\n";
			    print "<td>" . $rec[2] . "</td>\n";
			    print "<td>" . $rec[3] . "</td>\n";
			    print "<td>" . $rec[4] . "</td>\n";
			    print "</tr>\n";
		    }
		    print "</table>\n";
		    #’¥¹’¥Æ’¡¼’¥È’¥á’¥ó’¥È’¥Ï’¥ó’¥É’¥ë’¥¯’¥ê’¥¢
		    $sth->finish;
		    #DB’ÀÚ’ÃÇ 
	            $dbh->disconnect;
}


#---------------------
#’¿·’¥³’¡¼’¥¹’ÁÞ’Æþ
#---------------------
sub post_data{
	#’Æþ’ÎÏ’»þ’¥¨’¥é’¡¼’³Î’Ç§
	if(	$course_id !~ /^[a-zA-Z0-9-]{1,20}$/ || 
		$course_title !~ /^.{1,50}$/ || 
		$topic !~ /^.{0,100}$/ || 
		$day_length !~ /^[1-9][0-9]?$/|| 
		$price !~ /^\d{1,6}$/ || 
		$level_id !~ /^[1-5]$/ || 
		$category !~ /^[a-zA-Z0-9-]{1,20}$/
		){
			&validation_error();
	}
	else
	{

	#’¥³’¡¼’¥¹’ÁÞ’Æþ
	&dbh();
	my $sth = $dbh->prepare(
		"INSERT INTO course 
		VALUES(
		'$course_id',
		'$course_title',
		'$topic',
		'$day_length',
		'$price',
		'$level_id',
		'$category'
		)");
	if(!$sth->execute){
		    print "SQL’¼º’ÇÔ\n";
		    exit;
	    }
	$sth->finish;
	$dbh->disconnect;

    	#’¥³’¡¼’¥¹’´°’À®’¥Ú’¡¼’¥¸’É½’¼¨
	&renew();
	}
}

#----------------------
#keyword’¸¡’º÷
#----------------------
sub key{
	if($key eq ""){
		&main();  
		exit;
	}else{
		print "<h3>found courses</h3>\n";
		&dbh();
		if(!$dbh){
			print "’ÀÜ’Â³’¼º’ÇÔ\n";
			exit;
		}
#’·ï’¿ô’¼è’ÆÀ

		my $sql = "select count(*) from course ";
	     	$sql .= "where course_id like '%$key%' or";
	     	$sql .= " course_title like '$key%' or";
		$sql .= " topic like '%$key%' or";
	  	$sql .= " day_length like '%$key%' or";
	     	$sql .= " price like '%$key%' or";
	     	$sql .= " level_id like '%$key%' or";
	     	$sql .= " category like '%$key%'";


		my $sth = $dbh->prepare($sql);
		if(!$sth->execute){
		print "SQL’¼º’ÇÔ\n";
		exit;
	}
	my @rec = $sth->fetchrow_array;
	my $cnt = $rec[0];
	print "rows...$rec[0]\n";


my $sql = "select course_id, course_title, price, level_id, category from course ";
    $sql .= "where course_id like '%$key%' or";
   $sql .= " course_title like '$key%' or";
   $sql .= " topic like '%$key%' or";
   $sql .= " day_length like '%$key%' or";
   $sql .= " price like '%$key%' or";
   $sql .= " level_id like '%$key%' or";
   $sql .= " category like '%$key%'";
   $sql .= " order by course_id";

   my $sth = $dbh->prepare($sql);
   if(!$sth->execute){
	print "SQL’¼º’ÇÔ\n";
	exit;
}

print "<table border=1>\n";
	    print "<tr><th>course_id</th><th>title</th><th>price</th><th>level_id</th><th>category</th></tr>\n";
	    while(my @rec = $sth->fetchrow_array()) {
			    print "<tr>\n";
			    print qq|<td><a href="course_s.pl?mode=$rec[0]"> $rec[0] </a></td>\n|;
			    print "<td>" . $rec[1] . "</td>\n";
			    print "<td>" . $rec[2] . "</td>\n";
			    print "<td>" . $rec[3] . "</td>\n";
			    print "<td>" . $rec[4] . "</td>\n";
			    print "</tr>\n";
		    }
		    print "</table>\n";
		    $sth->finish;
	            $dbh->disconnect;
	    }
    }
    



#----------------------
#’¹¹’¿·’¥Ú’¡¼’¥¸
#----------------------
sub renew{
#open IN, "$created_course";
print <<EOM;
<h3>course created.</h3>
<a href="../../cgi-bin/Wapp/Wapp.pl?mode=delete">delete this course? ...</a>
<p>
<form action=renew.pl method="post">
<table border>
<tr><th>course_id</th>
<td> <input type="hidden" name="course_id" value="$course_id" size="20"> $course_id</td></tr>
<tr><th>course_title</th>
<td><input type="text" name="course_title" value="$course_title" size="20"></td></tr>
<tr><th>topic</th>
<td><textarea type="text" name="topic" cols="20" rows="3">$topic</textarea></td></tr>
<tr><th>day_length</th>
<td><input type="text" name="day_length" value="$day_length" size="20"></td></tr>
<tr><th>price</th>
<td><input type="text" name="price" value="$price" size="20"></td></tr>
<tr><th>level_id</th> 
<td><input type="text" name="level_id" value="$level_id" size="20"></td></tr>
<tr><th>category</th>
<td><input type="text" name="category" value="$category" size="20"></td></tr>
</table>
<br>
<input type="submit" value="’Á÷’¿®">
</p>
</form>
EOM
#	print <IN>;
#	close (IN);
} 	

#----------------------
#’¹¹’¿·’¥Ç’¡¼’¥¿’¤Î’ÁÞ’Æþ
#----------------------
sub renew_post{
	print "renew_post\n";
	print "$course_id\n";
	&dbh();
	my $sth = $dbh->prepare(
		"updata course set 
		course_title = '$course_title',
		topic = '$topic',
		day_length = '$day_length',
		price = '$price',
		level_id = '$level_id',
		category = '$category',
		where id = '$course_id'");
		print "13\n";
	if(!$sth->execute){
	print "SQL’¼º’ÇÔ\n";
	exit;
	}
	$sth->finish;
	$dbh->disconnect;
	print "updated\n";
	&renew();
}


#----------------------
#’¥Ø’¥Ã’¥À’¡¼’¤Î’Àß’Äê
#----------------------
sub header{
#	my $ttl =shift;	

	print "Content-type: text/html\n\n";
    	print  <<"EOM";
<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=Shift_JIS">
</head>
<body>
<a href="Wapp.pl?mode=main">Top</a> |
<a href="Wapp.pl?mode=create">create course</a> |
<a href="Wapp.pl?mode=all">all course</a> |
<hr>
EOM
	}

#----------------------
#’¥Õ’¥Ã’¥À’¡¼’¤Î’Àß’Äê
#----------------------
sub fooder{
print "<hr>\n";
print qq|<Div Align="right">Shian Izumida Webapp.</Div>\n|;
printf("DEBUG:elapsed time:%f  mili second\n",(Time::HiRes::time - $start_time)*1000);
print "</body>\n";
print "</html>\n";
}
#---------------------
#DB’ÀÜ’Â³
#---------------------
sub dbh{
	$dbh =DBI->connect("DBI:mysql:training_db", "root", "",{
		AutoCommit=>0,RaiseError=>1,PrintError=>0}) || die;
}

#----------------------
#html’¥Õ’¥¡’¥¤’¥ë’¤Î’¥ª’¡¼’¥×’¥ó
#----------------------
sub parse_form{
	my $q = new CGI::Fast();
	$mode = $q->param('mode');
	$post_data = $q->param('post_data');
	$course_id = $q->param("course_id");
	$course_title = $q->param("course_title");
	$topic = $q->param("topic");
	$day_length = $q->param("day_length");
	$price = $q->param("price");
	$level_id = $q->param("level_id");
	$category = $q->param("category");
	$renew_post = $q->param("renew_post");
	$key = $q->param('key');
}


#------------------------
#’Ç§’¾Ú’¼º’ÇÔ
#------------------------
sub validation_error{

	print "<h3>validation error</h3>\n";

	if($course_id !~ /^[a-zA-Z0-9-]{1,20}$/){
		print "course_id is not valid.<br>\n";
	}
	if($course_title !~ /^.{1,3}$/){
		print "course_title is not valid.<br>\n";
	}
	if($topic !~ /^.{0,100}$/){
		print "topic less than 101 words.<br>\n";
	}
	if($day_length !~ /^[1-9][0-9]$/){
		print "day_length between 1 and 99.<br>\n";
	}
	if($price !~ /^\d{1,6}$/){
		print "price between 0 and 999999.<br>\n";
	}
	if($level_id !~ /^[1-5]$/){
		print "level_id between 1 and 5.<br>\n";
	}
	if($category !~ /^[a-zA-Z0-9-]{1,20}$/){
		print "category is required and less than 40 characters.<br>\n";
	}

	print qq|<a href="Wapp.pl?mode=main">browser back or click.</a>\n|;
}
